<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Voting</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Poppins', sans-serif;
    }
    .vote-card {
      transition: all 0.3s ease;
    }
    .vote-card:hover {
      transform: translateY(-4px);
    }
    .progress-bar {
      transition: width 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-800 overflow-auto">
  <div id="app" class="w-full min-h-full p-6 md:p-8"><!-- Header -->
   <header class="text-center mb-8 fade-in relative"><button onclick="showSettingsModal()" class="absolute top-0 right-0 md:right-4 px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur text-white font-semibold rounded-xl transition-all shadow-lg border border-white/30 inline-flex items-center gap-2 text-sm md:text-base"> <span class="text-xl">âš™ï¸</span> <span class="hidden sm:inline">Pengaturan</span> </button>
    <div class="inline-flex items-center gap-3 mb-4"><span class="text-4xl">ğŸ—³ï¸</span>
     <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-white drop-shadow-lg">Pemilihan Ketua</h1>
    </div>
    <p class="text-purple-200 text-lg">Pilih calon favoritmu!</p>
   </header><!-- Voting Cards -->
   <div class="max-w-6xl mx-auto mb-10">
    <div id="candidates-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"><!-- Candidate cards will be rendered here -->
    </div>
   </div><!-- Results Section -->
   <div class="max-w-4xl mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 fade-in" style="animation-delay: 0.2s">
    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><span>ğŸ“Š</span> Hasil Voting Real-time</h2>
    <div id="results-container" class="space-y-4"><!-- Results will be rendered here -->
    </div>
    <div class="mt-6 pt-4 border-t border-white/20 flex justify-between items-center">
     <p class="text-purple-200">Total suara: <span id="total-votes" class="font-bold text-white">0</span></p><button id="reset-btn" onclick="showConfirmModal()" class="px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg font-medium transition-all text-sm hidden"> ğŸ”„ Reset Voting </button>
    </div>
   </div><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- Voter Name Modal -->
   <div id="voter-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">ğŸ—³ï¸</span>
      <h3 class="text-xl font-bold text-gray-800">Masukkan Nama Anda</h3>
      <p class="text-gray-600 text-sm mt-1">Voting untuk: <span id="voting-for-name" class="font-semibold text-purple-600"></span></p>
     </div>
     <form id="voter-form" onsubmit="handleVoterSubmit(event)"><label for="voter-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nama Pemilih</label> <input type="text" id="voter-name-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan nama Anda" required maxlength="50">
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideVoterNameModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> Vote Sekarang </button>
      </div>
     </form>
    </div>
   </div><!-- Confirm Reset Modal -->
   <div id="confirm-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 text-center"><span class="text-5xl mb-4 block">âš ï¸</span>
     <h3 class="text-xl font-bold text-gray-800 mb-2">Reset Voting?</h3>
     <p class="text-gray-600 mb-6">Semua suara akan dihapus. Tindakan ini tidak dapat dibatalkan.</p>
     <div class="flex gap-3 justify-center"><button id="cancel-reset" onclick="hideConfirmModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button id="confirm-reset" onclick="handleReset()" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all"> Ya, Reset </button>
     </div>
    </div>
   </div><!-- Settings Modal -->
   <div id="settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center overflow-y-auto p-4">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full my-8 max-h-[90vh] overflow-y-auto">
     <div class="text-center mb-6"><span class="text-5xl mb-3 block">âš™ï¸</span>
      <h3 class="text-2xl font-bold text-gray-800">Pengaturan Voting</h3>
      <p class="text-gray-600 text-sm mt-1">Kelola judul dan kandidat voting Anda</p>
     </div><!-- Edit Title Section -->
     <div class="mb-6 pb-6 border-b border-gray-200">
      <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ğŸ“</span> Judul Voting</h4>
      <form id="title-form" onsubmit="handleTitleUpdate(event)"><label for="title-input" class="block text-sm font-medium text-gray-700 mb-2">Judul</label> <input type="text" id="title-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors mb-3" placeholder="Masukkan judul voting" required maxlength="100"> <button type="submit" class="w-full px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> ğŸ’¾ Simpan Judul </button>
      </form>
     </div><!-- Manage Candidates Section -->
     <div class="mb-6">
      <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2"><span>ğŸ‘¥</span> Kelola Kandidat</h4>
      <div id="settings-candidates-list" class="space-y-3 mb-4"><!-- Candidates will be rendered here -->
      </div><button onclick="showAddCandidateModal()" class="w-full px-4 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2"> <span class="text-xl">â•</span> Tambah Kandidat Baru </button>
     </div><!-- Close Button --> <button onclick="hideSettingsModal()" class="w-full px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Tutup </button>
    </div>
   </div><!-- Edit Candidate Modal -->
   <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">âœï¸</span>
      <h3 class="text-xl font-bold text-gray-800">Edit Nama Kandidat</h3>
     </div>
     <form id="edit-form" onsubmit="handleEditSubmit(event)"><label for="edit-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nama Kandidat</label> <input type="text" id="edit-name-input" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan nama kandidat" required maxlength="50">
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideEditModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all"> Simpan </button>
      </div>
     </form>
    </div>
   </div><!-- Add Candidate Modal -->
   <div id="add-candidate-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 w-full">
     <div class="text-center mb-4"><span class="text-4xl mb-2 block">â•</span>
      <h3 class="text-xl font-bold text-gray-800">Tambah Kandidat Baru</h3>
     </div>
     <form id="add-candidate-form" onsubmit="handleAddCandidate(event)"><label for="new-candidate-name" class="block text-sm font-medium text-gray-700 mb-2">Nama Kandidat</label> <input type="text" id="new-candidate-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors" placeholder="Masukkan nama kandidat baru" required maxlength="50">
      <div class="flex gap-3 mt-6"><button type="button" onclick="hideAddCandidateModal()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-all"> Batal </button> <button type="submit" class="flex-1 px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-all"> Tambah </button>
      </div>
     </form>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      voting_title: 'Pemilihan Ketua',
      candidate_1: 'Kandidat 1',
      background_color: '#4c1d95',
      card_color: '#ffffff',
      text_color: '#1f2937',
      primary_action_color: '#8b5cf6',
      secondary_action_color: '#ec4899'
    };

    // Candidate data with emojis and colors
    const candidateStyles = [
      { emoji: 'ğŸ‘¤', gradient: 'from-blue-500 to-cyan-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-emerald-500 to-teal-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-orange-500 to-amber-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-pink-500 to-rose-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-violet-500 to-purple-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-red-500 to-pink-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-yellow-500 to-orange-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-teal-500 to-cyan-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-indigo-500 to-blue-400' },
      { emoji: 'ğŸ‘¤', gradient: 'from-lime-500 to-green-400' }
    ];

    // State
    let votes = [];
    let config = { ...defaultConfig };
    let isResetting = false;
    let currentEditingCandidateId = null;
    let currentVotingCandidateId = null;
    let candidates = [];
    let hasVoted = false;
    let deviceId = '';

    // Generate or retrieve device ID
    function getDeviceId() {
      let id = localStorage.getItem('voting_device_id');
      if (!id) {
        id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('voting_device_id', id);
      }
      return id;
    }

    // Check if device has voted
    function checkIfVoted() {
      deviceId = getDeviceId();
      hasVoted = votes.some(vote => vote.voter_name === deviceId || vote.voter_name.startsWith(deviceId + '|'));
    }

    // Load candidates from config
    function loadCandidates() {
      candidates = [];
      let i = 1;
      while (true) {
        const key = `candidate_${i}`;
        const name = config[key] !== undefined && config[key] !== '' ? config[key] : (i === 1 ? defaultConfig[key] : null);
        if (name && name !== '') {
          candidates.push({
            id: String(i),
            name: name
          });
          i++;
        } else if (i === 1) {
          if (defaultConfig[key]) {
            candidates.push({
              id: String(i),
              name: defaultConfig[key]
            });
          }
          i++;
        } else {
          const nextKey = `candidate_${i + 1}`;
          if (config[nextKey] && config[nextKey] !== '') {
            i++;
            continue;
          }
          break;
        }
      }
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          loadCandidates();
          renderCandidates();
          renderResults();
          updateTitle();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => window.elementSdk.config.background_color || defaultConfig.background_color,
              set: (v) => { window.elementSdk.config.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => window.elementSdk.config.card_color || defaultConfig.card_color,
              set: (v) => { window.elementSdk.config.card_color = v; window.elementSdk.setConfig({ card_color: v }); }
            },
            {
              get: () => window.elementSdk.config.text_color || defaultConfig.text_color,
              set: (v) => { window.elementSdk.config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => window.elementSdk.config.primary_action_color || defaultConfig.primary_action_color,
              set: (v) => { window.elementSdk.config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); }
            },
            {
              get: () => window.elementSdk.config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (v) => { window.elementSdk.config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['voting_title', cfg.voting_title || defaultConfig.voting_title],
          ['candidate_1', cfg.candidate_1 || defaultConfig.candidate_1]
        ])
      });
      
      config = { ...defaultConfig, ...window.elementSdk.config };
    }

    // Data handler for Data SDK
    const dataHandler = {
      onDataChanged(data) {
        votes = data || [];
        checkIfVoted();
        renderResults();
        renderCandidates();
        updateResetButton();
      }
    };

    // Initialize Data SDK
    window.dataSdk.init(dataHandler);

    // Get candidate name by ID
    function getCandidateName(id) {
      const key = `candidate_${id}`;
      return config[key] || defaultConfig[key] || 'Unknown';
    }

    // Count votes for each candidate
    function countVotes() {
      const counts = {};
      candidates.forEach(c => {
        counts[c.id] = 0;
      });
      votes.forEach(vote => {
        if (counts.hasOwnProperty(vote.candidate_id)) {
          counts[vote.candidate_id]++;
        }
      });
      return counts;
    }

    // Update title
    function updateTitle() {
      const titleEl = document.getElementById('main-title');
      if (titleEl) {
        titleEl.textContent = config.voting_title || defaultConfig.voting_title;
      }
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
        type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-amber-500'
      } text-white font-medium`;
      toast.innerHTML = `
        <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'âš ï¸'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Render candidate cards
    function renderCandidates() {
      const grid = document.getElementById('candidates-grid');

      grid.innerHTML = candidates.map((candidate, index) => {
        const style = candidateStyles[index % candidateStyles.length];
        
        return `
          <div class="vote-card bg-white/95 backdrop-blur rounded-2xl overflow-hidden shadow-xl border border-white/50 fade-in" style="animation-delay: ${index * 0.1}s">
            <div class="bg-gradient-to-r ${style.gradient} p-6 text-center">
              <div class="w-20 h-20 mx-auto bg-white/30 rounded-full flex items-center justify-center text-4xl mb-3 shadow-inner">
                ${style.emoji}
              </div>
              <span class="text-white/80 text-sm font-medium">Calon ${candidate.id}</span>
            </div>
            <div class="p-5 text-center">
              <h3 class="text-xl font-bold text-gray-800 mb-4 truncate" title="${candidate.name}">${candidate.name}</h3>
              ${hasVoted ? `
                <button 
                  class="w-full py-3 bg-gray-400 cursor-not-allowed text-white font-semibold rounded-xl shadow-md"
                  disabled
                  title="Anda sudah melakukan voting"
                >
                  âœ… Sudah Vote
                </button>
              ` : `
                <button 
                  onclick="handleVote('${candidate.id}')"
                  class="w-full py-3 bg-gradient-to-r ${style.gradient} text-white font-semibold rounded-xl hover:opacity-90 transition-all shadow-md hover:shadow-lg"
                >
                  ğŸ—³ï¸ Vote
                </button>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    // Render results
    function renderResults() {
      const container = document.getElementById('results-container');
      const totalVotesEl = document.getElementById('total-votes');
      const voteCounts = countVotes();
      const totalVotes = votes.length;

      totalVotesEl.textContent = totalVotes;

      const sortedCandidates = [...candidates].sort((a, b) => voteCounts[b.id] - voteCounts[a.id]);

      container.innerHTML = sortedCandidates.map((candidate, index) => {
        const count = voteCounts[candidate.id] || 0;
        const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
        const style = candidateStyles[parseInt(candidate.id) - 1] || candidateStyles[0];
        const isLeading = index === 0 && count > 0;
        
        const votersForCandidate = votes.filter(v => v.candidate_id === candidate.id);
        const votersList = votersForCandidate.map(v => {
          const parts = v.voter_name.split('|');
          return parts.length > 1 ? parts[1] : v.voter_name;
        }).join(', ');

        return `
          <div class="bg-white/10 rounded-xl p-4 ${isLeading ? 'ring-2 ring-yellow-400' : ''}">
            <div class="flex justify-between items-center mb-2">
              <div class="flex items-center gap-2">
                ${isLeading ? '<span class="text-yellow-400">ğŸ‘‘</span>' : ''}
                <span class="font-semibold text-white truncate max-w-[150px] sm:max-w-none">${candidate.name}</span>
              </div>
              <span class="text-purple-200 font-medium">${count} suara (${percentage}%)</span>
            </div>
            <div class="h-3 bg-white/20 rounded-full overflow-hidden mb-2">
              <div 
                class="progress-bar h-full bg-gradient-to-r ${style.gradient} rounded-full"
                style="width: ${percentage}%"
              ></div>
            </div>
            ${votersForCandidate.length > 0 ? `
              <div class="text-xs text-purple-200 mt-2">
                <span class="font-medium">Pemilih:</span> ${votersList}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Update reset button visibility
    function updateResetButton() {
      const resetBtn = document.getElementById('reset-btn');
      if (votes.length > 0) {
        resetBtn.classList.remove('hidden');
      } else {
        resetBtn.classList.add('hidden');
      }
    }

    // Handle vote
    async function handleVote(candidateId) {
      if (hasVoted) {
        showToast('Anda sudah melakukan voting dari perangkat ini!', 'warning');
        return;
      }

      if (votes.length >= 999) {
        showToast('Batas maksimum 999 suara telah tercapai!', 'warning');
        return;
      }

      showVoterNameModal(candidateId);
    }

    // Show voter name modal
    function showVoterNameModal(candidateId) {
      currentVotingCandidateId = candidateId;
      const input = document.getElementById('voter-name-input');
      input.value = '';
      
      const modal = document.getElementById('voter-modal');
      const candidateName = document.getElementById('voting-for-name');
      candidateName.textContent = getCandidateName(candidateId);
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      setTimeout(() => input.focus(), 100);
    }

    // Hide voter name modal
    function hideVoterNameModal() {
      const modal = document.getElementById('voter-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentVotingCandidateId = null;
    }

    // Handle voter submit
    async function handleVoterSubmit(event) {
      event.preventDefault();
      
      if (!currentVotingCandidateId) return;
      
      const input = document.getElementById('voter-name-input');
      const voterName = input.value.trim();
      
      if (!voterName) {
        showToast('Nama pemilih tidak boleh kosong!', 'warning');
        return;
      }

      const submitBtn = event.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'â³ Memproses...';

      const voterData = deviceId + '|' + voterName;

      const result = await window.dataSdk.create({
        candidate_id: currentVotingCandidateId,
        voter_name: voterData,
        voted_at: new Date().toISOString()
      });

      if (result.isOk) {
        hasVoted = true;
        showToast(`Terima kasih ${voterName}! Suara untuk ${getCandidateName(currentVotingCandidateId)} berhasil dicatat.`);
        hideVoterNameModal();
      } else {
        showToast('Gagal mencatat suara. Silakan coba lagi.', 'error');
      }

      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Vote Sekarang';
    }

    // Show confirm modal
    function showConfirmModal() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // Hide confirm modal
    function hideConfirmModal() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Show settings modal
    function showSettingsModal() {
      const modal = document.getElementById('settings-modal');
      const titleInput = document.getElementById('title-input');
      
      titleInput.value = config.voting_title || defaultConfig.voting_title;
      renderSettingsCandidatesList();
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // Hide settings modal
    function hideSettingsModal() {
      const modal = document.getElementById('settings-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Render candidates list in settings modal
    function renderSettingsCandidatesList() {
      const container = document.getElementById('settings-candidates-list');
      
      container.innerHTML = candidates.map((candidate, index) => {
        const votesForCandidate = votes.filter(v => v.candidate_id === candidate.id).length;
        const canDelete = votesForCandidate === 0;
        
        return `
          <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-sm font-medium text-gray-500">Calon ${candidate.id}</span>
                ${votesForCandidate > 0 ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${votesForCandidate} suara</span>` : ''}
              </div>
              <p class="font-semibold text-gray-800">${candidate.name}</p>
            </div>
            <button 
              onclick="showEditModalFromSettings('${candidate.id}')"
              class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all text-sm"
              title="Edit nama kandidat"
            >
              âœï¸
            </button>
            <button 
              onclick="handleDeleteCandidateFromSettings('${candidate.id}')"
              class="px-3 py-2 ${canDelete ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-400 cursor-not-allowed'} text-white rounded-lg font-medium transition-all text-sm"
              ${!canDelete ? 'disabled' : ''}
              title="${canDelete ? 'Hapus kandidat' : `Tidak dapat dihapus (${votesForCandidate} suara)`}"
            >
              ğŸ—‘ï¸
            </button>
          </div>
        `;
      }).join('');
    }

    // Handle title update
    function handleTitleUpdate(event) {
      event.preventDefault();
      
      const input = document.getElementById('title-input');
      const newTitle = input.value.trim();
      
      if (!newTitle) {
        showToast('Judul tidak boleh kosong!', 'warning');
        return;
      }

      window.elementSdk.setConfig({ voting_title: newTitle });
      showToast('Judul berhasil diubah!');
    }

    // Show edit modal from settings
    function showEditModalFromSettings(candidateId) {
      showEditModal(candidateId);
    }

    // Show edit modal
    function showEditModal(candidateId) {
      currentEditingCandidateId = candidateId;
      const currentName = getCandidateName(candidateId);
      const input = document.getElementById('edit-name-input');
      input.value = currentName;
      
      const modal = document.getElementById('edit-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      setTimeout(() => input.focus(), 100);
    }

    // Hide edit modal
    function hideEditModal() {
      const modal = document.getElementById('edit-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      currentEditingCandidateId = null;
      
      const settingsModal = document.getElementById('settings-modal');
      if (!settingsModal.classList.contains('hidden')) {
        renderSettingsCandidatesList();
      }
    }

    // Handle edit submit
    function handleEditSubmit(event) {
      event.preventDefault();
      
      if (!currentEditingCandidateId) return;
      
      const input = document.getElementById('edit-name-input');
      const newName = input.value.trim();
      
      if (!newName) {
        showToast('Nama tidak boleh kosong!', 'warning');
        return;
      }

      const configKey = `candidate_${currentEditingCandidateId}`;
      const updateObj = {};
      updateObj[configKey] = newName;
      
      window.elementSdk.setConfig(updateObj);
      showToast(`Nama kandidat berhasil diubah!`);
      hideEditModal();
    }

    // Show add candidate modal
    function showAddCandidateModal() {
      const input = document.getElementById('new-candidate-name');
      input.value = '';
      
      const modal = document.getElementById('add-candidate-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      setTimeout(() => input.focus(), 100);
    }

    // Hide add candidate modal
    function hideAddCandidateModal() {
      const modal = document.getElementById('add-candidate-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      
      const settingsModal = document.getElementById('settings-modal');
      if (!settingsModal.classList.contains('hidden')) {
        renderSettingsCandidatesList();
      }
    }

    // Handle add candidate
    function handleAddCandidate(event) {
      event.preventDefault();
      
      const input = document.getElementById('new-candidate-name');
      const newName = input.value.trim();
      
      if (!newName) {
        showToast('Nama tidak boleh kosong!', 'warning');
        return;
      }

      let nextId = candidates.length + 1;
      const configKey = `candidate_${nextId}`;
      const updateObj = {};
      updateObj[configKey] = newName;
      
      window.elementSdk.setConfig(updateObj);
      showToast(`Kandidat baru "${newName}" berhasil ditambahkan!`);
      hideAddCandidateModal();
    }

    // Handle delete candidate from settings
    function handleDeleteCandidateFromSettings(candidateId) {
      const candidateName = getCandidateName(candidateId);
      const votesForCandidate = votes.filter(v => v.candidate_id === candidateId).length;
      
      if (votesForCandidate > 0) {
        showToast(`Tidak dapat menghapus ${candidateName} karena sudah memiliki ${votesForCandidate} suara`, 'warning');
        return;
      }

      const configKey = `candidate_${candidateId}`;
      const updateObj = {};
      updateObj[configKey] = '';
      
      window.elementSdk.setConfig(updateObj);
      showToast(`Kandidat "${candidateName}" berhasil dihapus!`);
      
      setTimeout(() => renderSettingsCandidatesList(), 300);
    }

    // Handle reset
    async function handleReset() {
      if (isResetting || votes.length === 0) return;
      
      isResetting = true;
      hideConfirmModal();
      
      const resetBtn = document.getElementById('reset-btn');
      resetBtn.disabled = true;
      resetBtn.innerHTML = 'â³ Mereset...';

      for (const vote of [...votes]) {
        await window.dataSdk.delete(vote);
      }

      localStorage.removeItem('voting_device_id');
      hasVoted = false;
      deviceId = getDeviceId();

      showToast('Voting telah direset!');
      isResetting = false;
      resetBtn.disabled = false;
      resetBtn.innerHTML = 'ğŸ”„ Reset Voting';
    }

    // Initial render
    deviceId = getDeviceId();
    loadCandidates();
    renderCandidates();
    renderResults();
    updateTitle();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7baa6e013f9c33',t:'MTc3MDA1NjA0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
